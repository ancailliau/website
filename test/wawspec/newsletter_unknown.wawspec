scenario __FILE__ do 
  people_mail, people = "test-user@acmscw.be", {:mail => "test-user@acmscw.be"}
  Waw.resources.business.people.drop_people(people_mail)
  AcmScW::Tools::MailServer.clean(people_mail)
  
  # Start on the root
  go Waw.config.web_base
  
  # invoke the subscribe_account service
  assert_form_service_invoke "Successful newsletter invocation", {
    :service    => "/webserv/people/newsletter_subscribe",
    :arguments  => people,
    :result     => "success/ok"
  }
  
  # Check the confirmation message
  href, actkey = assert_activation_mail_sent(people_mail)
  
  # Follow the activation link
  assert_not_404 href, "Activation link lead to a valid page"
  assert_has_tag "form", :id => "activate_account"
  
  # Fill the form and send it
  args = people.merge(:actkey => actkey, :password => "password", :password_confirm => "password")
  assert_form_service_invoke "Successful activate service invocation", {
    :service    => "/webserv/people/activate_account",
    :arguments  => args,
    :result     => "success/ok"
  }
  
  # I'm now on the people/my_chapter page
  assert_i_see "<!-- pages/people/my_chapter.wtpl -->", "User is on the my_chapter page"

  # Second activation fails
  assert_form_service_invoke "Second activation with same key fails", {
    :service    => "/webserv/people/activate_account",
    :arguments  => args,
    :result     => "success/ko",
    :check_form => false
  }

end