scenario __FILE__ do
  people_mail = "test-user@acmscw.be"
  people = {:mail       => people_mail,
            :password   => "mypassword", 
            :password_confirm => "mypassword",
            :newsletter => "true"}
  Waw.resources.business.people.drop_people(people_mail)
  AcmScW::Tools::MailServer.clean(people_mail)
  
  # Start on the root
  go Waw.config.web_base
  
  # Go through the subscription link
  follow 'a', :href => '/people/subscribe'
  assert_i_see "<!-- people/subscribe.wtpl -->", "User is on the subscribe page"
  assert has_tag?("form", :id => "subscribe_account")
  
  # invoke the subscribe_account service
  assert_form_service_invoke "Successful subscribe service invocation", {
    :service    => "/services/subscribe_account",
    :arguments  => people,
    :result     => "success/ok"
  }
  assert_i_see Waw.resources.messages.subscribe_account_ok, "Feedback message subscribe_account_ok seen"
  
  # Check the confirmation message
  href, actkey = assert_activation_mail_sent(people_mail)
  
  # Follow the activation link
  assert_not_404 href, "Activation link lead to a valid page"
  assert_has_tag "form", :id => "activate_account"
  
  # Fill the form and send it
  assert_form_service_invoke "Successful activate service invocation", {
    :service    => "/services/activate_account",
    :arguments  => people.merge(:actkey => actkey),
    :result     => "success/ok"
  }
  
  # I'm now on the people/my_chapter page
  assert_i_see "<!-- people/my_chapter.wtpl -->", "User is on the my_chapter page"
  assert_i_see "A propos de vous"
end