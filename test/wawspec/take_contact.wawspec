scenario __FILE__ do
  args = {:mail       => "test-user@acmscw.be",
          :subject    => "This is my subject", 
          :message    => "This is my message"}
  AcmScW::Tools::MailServer.clean("info@uclouvain.acm-sc.be")
  
  # Start on the root
  go Waw.config.web_base
  
  # Go through the contact link
  follow 'a', :href => '/contact'
  assert_i_see "<!-- pages/contact.wtpl -->", "User is on the contact page"
  
  # invoke the subscribe_account service
  assert_form_service_invoke "Successful contact service invocation", {
    :service    => "/webserv/main/send_message",
    :arguments  => args,
    :result     => "success/ok"
  }
  assert_i_see Waw.resources.messages.contact_ok, "Feedback message contact_ok seen"
  
  # Check the confirmation message
  contents = assert_mail_sent("info@uclouvain.acm-sc.be")
  assert contents =~ /This is my message/, "Message is in the mail"
  assert contents =~ /^Subject: This is my subject$/, "With the correct subject"
  assert contents =~ /^From: test-user@acmscw.be$/, "From the correct user"
  assert contents =~ /^To: info@uclouvain.acm-sc.be$/, "To the correct user"
  
  # Checks that it blocks without message
  result = invoke_json_service("/webserv/main/send_message", args.keep(:mail, :subject))
  assert_equal ["validation-ko", ["missing_message"]], result
  result = invoke_json_service("/webserv/main/send_message", args.keep(:mail, :subject, :message => "               "))
  assert_equal ["validation-ko", ["missing_message"]], result
end