wawaccess do
  inherits true
  strategy :deny_all

  match /events\/([a-zA-Z0-9_]+)\.csv$/ do |url, event_id|
    if session.adminlevel > 2
      require 'fastercsv'
      rel = AcmScW.database[:event_interested_people].filter(:event_id => event_id)
      fields = [:event_id, :event_name, :event_start_time, :event_end_time, :people_mail, :people_name, :people_occupation]
      csv_string = FasterCSV.generate do |csv|
        csv << fields
        rel.order(:people_name).each {|row| csv << fields.collect{|field| row[field]}}
      end
      [200, {'Content-Type' => 'text/plain; charset=utf8',
             'Content-disposition' => "attachment; filename=#{event_id}_registrations.csv"}, 
             [csv_string.to_s]]
    else
      deny
    end
  end
  
  match /events\/([a-zA-Z0-9_]+)$/ do |url, event_id|
    event = AcmScW.database[:events].filter(:id => event_id).first
    if event
      registered = AcmScW.database[:event_interested_people].filter(:event_id => event_id)
      wlang '../../templates/layout.wtpl', {:title    => event[:name], 
                                            "served_file" => 'pages/events/card.wbrick',
                                            :theclass => "other",
                                            :event => event, :registered => registered}
    else
      apply '/pages/404.wtpl', 404
    end
  end
  
end