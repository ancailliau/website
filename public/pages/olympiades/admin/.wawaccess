wawaccess do
  
  # We don't inherits static configuration
  inherits false
  
  # By default, we deny the call
  strategy :deny_all
  
  # Send the inscriptions.csv file
  match 'inscriptions.csv' do
    if session.adminlevel > 2
      require 'fastercsv'
      fields = [:id, :gender, :first_name, :last_name, :mail, :birthdate,
      :street, :postal_code, :city, :school_name, :school_city,
      :category, :study_level, :orientation, :orientation_other,
      :center, :knowshow, :knowshow_other]
      csv_string = FasterCSV.generate do |csv|
        csv << fields
        Waw.resources.model.olympiades_registrations.order(:id).each do |row|
          csv << fields.collect{|field| row[field]}
        end  
      end
      [200, {'Content-Type' => 'text/plain; charset=utf8',
             'Content-disposition' => 'attachment; filename=olympiades_inscriptions.csv'}, 
             [csv_string.to_s]]
    else
      deny
    end
  end
  
  # When the file cannot be found
  match true do
    deny
  end
  
end